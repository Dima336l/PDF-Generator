name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create virtual environment
      run: python3 -m venv venv
    
    - name: Activate virtual environment and install dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous builds
      run: |
        rm -rf build/
        rm -rf dist/
    
    - name: Build macOS app
      run: |
        source venv/bin/activate
        pyinstaller PropertyPDFBuilder_macos.spec
    
    - name: Create DMG (optional)
      run: |
        if [ -d "dist/PropertyPDFBuilder.app" ]; then
          hdiutil create -volname "Property PDF Builder" -srcfolder dist/PropertyPDFBuilder.app -ov -format UDZO dist/PropertyPDFBuilder.dmg || true
        fi
    
    - name: Upload app bundle
      uses: actions/upload-artifact@v3
      with:
        name: PropertyPDFBuilder-macOS
        path: |
          dist/PropertyPDFBuilder.app
          dist/PropertyPDFBuilder.dmg
        retention-days: 30

