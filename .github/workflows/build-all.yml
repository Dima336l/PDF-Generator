name: Build All Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verify required files
      shell: cmd
      run: |
        echo Checking for required files...
        dir
        if not exist logo.png (
          echo ERROR: logo.png is required but not found!
          exit /b 1
        ) else (
          echo logo.png found
        )
        echo sample_images not needed - users will paste their own images
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create virtual environment
      run: python -m venv venv
    
    - name: Activate virtual environment and install dependencies
      shell: cmd
      run: |
        call venv\Scripts\activate.bat
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous builds
      shell: cmd
      run: |
        if exist build rmdir /s /q build
        if exist dist rmdir /s /q dist
    
    - name: Build Windows executable
      shell: cmd
      run: |
        call venv\Scripts\activate.bat
        echo Building Windows executable with logo.png...
        pyinstaller --onefile --windowed --name PropertyPDFBuilder --add-data "logo.png;." pdf_builder_app.py
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: PropertyPDFBuilder-Windows
        path: dist/PropertyPDFBuilder.exe
        retention-days: 30

  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verify required files
      run: |
        echo "Checking for required files..."
        ls -la
        if [ ! -f "logo.png" ]; then
          echo "ERROR: logo.png is required but not found!"
          exit 1
        else
          echo "âœ“ logo.png found"
        fi
        echo "sample_images not needed - users will paste their own images"
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create virtual environment
      run: python3 -m venv venv
    
    - name: Activate virtual environment and install dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous builds
      run: |
        rm -rf build/
        rm -rf dist/
        rm -rf PropertyPDFBuilder.app
    
    - name: Build macOS app
      run: |
        source venv/bin/activate
        pyinstaller PropertyPDFBuilder_macos.spec
    
    - name: Create macOS app bundle
      run: |
        if [ -d "dist/PropertyPDFBuilder" ]; then
          # Create .app bundle structure
          mkdir -p dist/PropertyPDFBuilder.app/Contents/MacOS
          mkdir -p dist/PropertyPDFBuilder.app/Contents/Resources
          
          # Move the executable
          mv dist/PropertyPDFBuilder/PropertyPDFBuilder dist/PropertyPDFBuilder.app/Contents/MacOS/
          
          # CRITICAL: Set executable permissions on the binary
          chmod +x dist/PropertyPDFBuilder.app/Contents/MacOS/PropertyPDFBuilder
          
          # Move all other files to Resources
          mv dist/PropertyPDFBuilder/* dist/PropertyPDFBuilder.app/Contents/Resources/ 2>/dev/null || true
          
          # Create Info.plist using echo commands
          echo '<?xml version="1.0" encoding="UTF-8"?>' > dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<plist version="1.0">' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<dict>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleExecutable</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>PropertyPDFBuilder</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleIdentifier</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>com.propertypdfbuilder.app</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleName</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>Property PDF Builder</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundlePackageType</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>APPL</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleVersion</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>1.0</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleShortVersionString</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>1.0</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>LSMinimumSystemVersion</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>10.13</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '</dict>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '</plist>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          
          # Remove the old directory
          rmdir dist/PropertyPDFBuilder 2>/dev/null || rm -rf dist/PropertyPDFBuilder
          
          # Verify the app bundle structure
          echo "App bundle created. Verifying structure..."
          ls -la dist/PropertyPDFBuilder.app/Contents/MacOS/
          file dist/PropertyPDFBuilder.app/Contents/MacOS/PropertyPDFBuilder
        fi
    
    - name: Create DMG
      run: |
        if [ -d "dist/PropertyPDFBuilder.app" ]; then
          # Create a temporary directory for DMG contents
          mkdir -p dist/dmg_contents
          
          # Copy app to DMG directory
          cp -R dist/PropertyPDFBuilder.app dist/dmg_contents/
          
          # Copy installation instructions
          if [ -f "MACOS_INSTALL_INSTRUCTIONS.md" ]; then
            cp MACOS_INSTALL_INSTRUCTIONS.md dist/dmg_contents/INSTALL_INSTRUCTIONS.txt
          fi
          
          # Create symbolic link to Applications folder (standard macOS DMG practice)
          ln -s /Applications dist/dmg_contents/Applications
          
          # Create DMG with proper formatting
          hdiutil create -volname "Property PDF Builder" -srcfolder dist/dmg_contents -ov -format UDZO dist/PropertyPDFBuilder.dmg || echo "DMG creation failed, but app bundle exists"
          
          # Clean up
          rm -rf dist/dmg_contents
        fi
    
    - name: Upload macOS app bundle
      uses: actions/upload-artifact@v4
      with:
        name: PropertyPDFBuilder-macOS
        path: |
          dist/PropertyPDFBuilder.app
          dist/PropertyPDFBuilder.dmg
        retention-days: 30
        if-no-files-found: warn

