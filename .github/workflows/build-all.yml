name: Build All Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verify required files
      shell: cmd
      run: |
        echo Checking for required files...
        dir
        if not exist logo.png (
          echo ERROR: logo.png is required but not found!
          exit /b 1
        ) else (
          echo logo.png found
        )
        if not exist sample_images (
          echo Warning: sample_images directory not found (will create empty)
          mkdir sample_images
        ) else (
          echo sample_images directory found
        )
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create virtual environment
      run: python -m venv venv
    
    - name: Activate virtual environment and install dependencies
      shell: cmd
      run: |
        call venv\Scripts\activate.bat
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous builds
      shell: cmd
      run: |
        if exist build rmdir /s /q build
        if exist dist rmdir /s /q dist
    
    - name: Check sample_images content
      shell: cmd
      run: |
        echo Checking sample_images directory...
        dir sample_images 2>nul || echo Directory is empty or doesn't exist
        if exist sample_images\*.jpg set HAS_IMAGES=1
        if exist sample_images\*.png set HAS_IMAGES=1
        if exist sample_images\*.jpeg set HAS_IMAGES=1
        if exist sample_images\*.webp set HAS_IMAGES=1
        if exist sample_images\*.gif set HAS_IMAGES=1
        if defined HAS_IMAGES (
          echo sample_images has files
        ) else (
          echo sample_images is empty
        )
    
    - name: Build Windows executable
      shell: cmd
      run: |
        call venv\Scripts\activate.bat
        echo Building Windows executable...
        if defined HAS_IMAGES (
          echo Including sample_images in build...
          pyinstaller --onefile --windowed --name PropertyPDFBuilder --add-data "logo.png;." --add-data "sample_images;sample_images" pdf_builder_app.py
        ) else (
          echo Building without sample_images...
          pyinstaller --onefile --windowed --name PropertyPDFBuilder --add-data "logo.png;." pdf_builder_app.py
        )
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: PropertyPDFBuilder-Windows
        path: dist/PropertyPDFBuilder.exe
        retention-days: 30

  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verify required files
      run: |
        echo "Checking for required files..."
        ls -la
        if [ ! -f "logo.png" ]; then
          echo "ERROR: logo.png is required but not found!"
          exit 1
        else
          echo "✓ logo.png found"
        fi
        if [ ! -d "sample_images" ]; then
          echo "Warning: sample_images directory not found (will create empty)"
          mkdir -p sample_images
        else
          echo "✓ sample_images directory found"
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Create virtual environment
      run: python3 -m venv venv
    
    - name: Activate virtual environment and install dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous builds
      run: |
        rm -rf build/
        rm -rf dist/
        rm -rf PropertyPDFBuilder.app
    
    - name: Build macOS app
      run: |
        source venv/bin/activate
        pyinstaller PropertyPDFBuilder_macos.spec
    
    - name: Create macOS app bundle
      run: |
        if [ -d "dist/PropertyPDFBuilder" ]; then
          # Create .app bundle structure
          mkdir -p dist/PropertyPDFBuilder.app/Contents/MacOS
          mkdir -p dist/PropertyPDFBuilder.app/Contents/Resources
          
          # Move the executable
          mv dist/PropertyPDFBuilder/PropertyPDFBuilder dist/PropertyPDFBuilder.app/Contents/MacOS/
          
          # Move all other files to Resources
          mv dist/PropertyPDFBuilder/* dist/PropertyPDFBuilder.app/Contents/Resources/ 2>/dev/null || true
          
          # Create Info.plist using echo commands
          echo '<?xml version="1.0" encoding="UTF-8"?>' > dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<plist version="1.0">' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '<dict>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleExecutable</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>PropertyPDFBuilder</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleIdentifier</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>com.propertypdfbuilder.app</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleName</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>Property PDF Builder</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundlePackageType</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>APPL</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleVersion</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>1.0</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>CFBundleShortVersionString</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>1.0</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <key>LSMinimumSystemVersion</key>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '  <string>10.13</string>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '</dict>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          echo '</plist>' >> dist/PropertyPDFBuilder.app/Contents/Info.plist
          
          # Remove the old directory
          rmdir dist/PropertyPDFBuilder 2>/dev/null || rm -rf dist/PropertyPDFBuilder
        fi
    
    - name: Create DMG
      run: |
        if [ -d "dist/PropertyPDFBuilder.app" ]; then
          hdiutil create -volname "Property PDF Builder" -srcfolder dist/PropertyPDFBuilder.app -ov -format UDZO dist/PropertyPDFBuilder.dmg || echo "DMG creation failed, but app bundle exists"
        fi
    
    - name: Upload macOS app bundle
      uses: actions/upload-artifact@v4
      with:
        name: PropertyPDFBuilder-macOS
        path: |
          dist/PropertyPDFBuilder.app
          dist/PropertyPDFBuilder.dmg
        retention-days: 30
        if-no-files-found: warn

